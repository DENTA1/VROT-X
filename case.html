<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Unbox Pro</title>
    
    <!-- Библиотеки -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet>
    <style>
        /* === Глобальные стили === */
        :root {
            --primary: #4cc9f0;
            --secondary: #e94560;
            --accent: #2ecc71;
            --bg: #0a0e1a;
            --card-bg: linear-gradient(145deg, #16213e 30%, #1a1a2e 100%);
            --text: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --success: #27ae60;
            --warning: #f1c40f;
            --danger: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === Хедер === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 5%;
            background: linear-gradient(45deg, #1a1a2e 0%, #0f3460 100%);
            box-shadow: var(--shadow);
            position: relative;
            z-index: 1000;
        }

        .back-button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .back-button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .back-button:hover::after {
            animation: shine 1.5s;
        }

        /* === Основной контент === */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 5%;
        }

        /* === Сетка кейсов === */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        /* === Карточка кейса === */
        .case-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transform-style: preserve-3d;
        }

        .case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(76, 201, 240, 0.2);
        }

        .case-image {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 1rem auto;
            filter: drop-shadow(0 5px 15px rgba(76, 201, 240, 0.3));
        }

        /* === Анимации === */
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* === Модальное окно === */
        .unbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* === Дополнительные элементы === */
        .balance {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }

        .currency {
            color: var(--primary);
            font-weight: bold;
        }

        /* ... ещё 300 строк стилей ... */
    </style>
</head>
<body>
    <header class="header">
        <button class="back-button" onclick="history.back()">
            ← Назад
        </button>
        <h1 class="title">Golden Unbox</h1>
        <div class="user-panel">
            <div class="balance">
                <span class="currency">₽</span>
                <span id="balance">0</span>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="cases-grid" id="casesGrid"></section>
        
        <section class="history-section">
            <h2>История открытий</h2>
            <div class="history-list" id="historyList"></div>
        </section>
    </main>

    <div class="unbox-modal" id="unboxModal">
        <div class="unbox-content">
            <div class="case-3d" id="case3d"></div>
            <div class="prize-reveal" id="prizeReveal"></div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.firebasestorage.app",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        class Game {
            constructor() {
                this.userId = this.getUserId();
                this.userData = null;
                this.cases = [
                    {
                        id: 'basic',
                        name: 'Базовый кейс',
                        price: 50,
                        image: 'https://via.placeholder.com/200/4cc9f0/0a0e1a?text=Basic',
                        items: [
                            { type: 'currency', value: 10, chance: 40 },
                            { type: 'currency', value: 50, chance: 30 },
                            { type: 'currency', value: 100, chance: 20 },
                            { type: 'currency', value: 500, chance: 8 },
                            { type: 'special', value: 'Golden Key', chance: 2 }
                        ]
                    },
                    // ... ещё 5 кейсов
                ];
                
                this.init();
            }

            async init() {
                if (!this.userId) return this.showAuthError();
                
                await this.loadUserData();
                this.setupEventListeners();
                this.renderCases();
                this.initAnimations();
            }

            getUserId() {
                const cookie = document.cookie.split('; ')
                    .find(row => row.startsWith('tg_user_id='));
                return cookie ? cookie.split('=')[1] : null;
            }

            async loadUserData() {
                try {
                    const snapshot = await database.ref(`users/${this.userId}`).once('value');
                    if (!snapshot.exists()) {
                        await database.ref(`users/${this.userId}`).set({
                            balance: 1000,
                            level: 1,
                            openedCases: 0
                        });
                    }
                    this.userData = snapshot.val();
                    this.updateUI();
                } catch (error) {
                    console.error('Ошибка загрузки данных:', error);
                }
            }

            renderCases() {
                const grid = document.getElementById('casesGrid');
                grid.innerHTML = this.cases.map(caseItem => `
                    <div class="case-card" data-case-id="${caseItem.id}">
                        <img src="${caseItem.image}" class="case-image">
                        <h3>${caseItem.name}</h3>
                        <p>Цена: ${caseItem.price}₽</p>
                        <button class="open-button" 
                            ${this.userData.balance < caseItem.price ? 'disabled' : ''}
                            onclick="game.openCase('${caseItem.id}')">
                            Открыть
                        </button>
                    </div>
                `).join('');
            }

            async openCase(caseId) {
                const selectedCase = this.cases.find(c => c.id === caseId);
                if (!selectedCase || this.userData.balance < selectedCase.price) return;

                // Списание средств
                await this.updateBalance(-selectedCase.price);
                
                // Выбор приза
                const prize = this.selectPrize(selectedCase.items);
                
                // Анимация
                this.playUnboxAnimation(prize);
                
                // Обновление данных
                await this.addToHistory(prize);
                this.updateUI();
            }

            selectPrize(items) {
                const totalChance = items.reduce((sum, item) => sum + item.chance, 0);
                const random = Math.random() * totalChance;
                let current = 0;
                
                for (const item of items) {
                    current += item.chance;
                    if (random <= current) return item;
                }
            }

            async updateBalance(amount) {
                try {
                    await database.ref(`users/${this.userId}/balance`).transaction(balance => {
                        return (balance || 0) + amount;
                    });
                } catch (error) {
                    console.error('Ошибка обновления баланса:', error);
                }
            }

            // ... ещё 200 строк методов ...

            updateUI() {
                document.getElementById('balance').textContent = this.userData.balance;
            }
        }

        // Инициализация игры
        const game = new Game();

        // Инициализация анимаций
        AOS.init({
            duration: 1000,
            once: true
        });
    </script>
</body>
</html>
