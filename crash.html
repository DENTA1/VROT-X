<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>UP-X Crash</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            background: #0d1117;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .crash-chart {
            background: #161b22;
            height: 300px;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
        }

        .multiplier {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #58ff58;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #fff;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .bet-button {
            background: #238636;
            color: #fff;
        }

        .cashout-button {
            background: #da3633;
            color: #fff;
        }

        .balance {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .history {
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="balance">Balance: $<span id="balance">0</span></div>
        <div class="crash-chart">
            <canvas id="chart"></canvas>
        </div>
        <div class="multiplier" id="multiplier">1.00x</div>
        <div class="controls">
            <input type="number" id="betAmount" placeholder="Сумма ставки">
            <button class="bet-button" onclick="placeBet()">Ставка</button>
            <button class="cashout-button" onclick="cashOut()">Забрать</button>
        </div>
        <div class="history">
            <h3>История игр:</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.firebasestorage.app",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let userRef;
        let currentGame;
        let isPlaying = false;
        let currentMultiplier = 1.0;
        let betAmount = 0;
        let chartCtx = document.getElementById('chart').getContext('2d');

        function getUserId() {
            let userId = document.cookie.replace(/(?:(?:^|.*;\s*)tg_user_id\s*\=\s*([^;]*).*$)|^.*$/, "$1");
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                document.cookie = `tg_user_id=${userId}; path=/; max-age=31536000`;
            }
            return userId;
        }

        function initUser() {
            const userId = getUserId();
            userRef = database.ref('users/' + userId);
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    userRef.set({
                        balance: 1000,
                        bets: [],
                        registered: new Date().toISOString()
                    });
                } else {
                    document.getElementById('balance').textContent = data.balance.toFixed(2);
                }
            });
        }

        function placeBet() {
            const betInput = parseFloat(document.getElementById('betAmount').value);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                if (betInput > user.balance) {
                    alert('Недостаточно средств!');
                    return;
                }
                
                betAmount = betInput;
                userRef.update({
                    balance: user.balance - betAmount
                });

                startGame();
            });
        }

        function startGame() {
            isPlaying = true;
            currentMultiplier = 1.0;
            const crashPoint = calculateCrashPoint();
            
            function gameLoop() {
                if (!isPlaying) return;
                
                currentMultiplier += 0.01 * Math.pow(1 + currentMultiplier/100, 2);
                document.getElementById('multiplier').textContent = currentMultiplier.toFixed(2) + 'x';
                
                if (currentMultiplier >= crashPoint) {
                    endGame(false);
                } else {
                    requestAnimationFrame(gameLoop);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        function calculateCrashPoint() {
            const e = 2**32;
            const h = crypto.getRandomValues(new Uint32Array(1))[0];
            return (Math.floor((100 * e - h) / (e - h)) / 100;
        }

        function cashOut() {
            if (isPlaying) {
                endGame(true);
            }
        }

        function endGame(manualCashout) {
            isPlaying = false;
            const winAmount = manualCashout ? betAmount * currentMultiplier : 0;
            
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                userRef.update({
                    balance: user.balance + winAmount,
                    bets: [...user.bets, {
                        amount: betAmount,
                        multiplier: manualCashout ? currentMultiplier.toFixed(2) : 0,
                        date: new Date().toISOString()
                    }]
                });
            });

            document.getElementById('multiplier').textContent = manualCashout ? 
                `Вы успели! ${currentMultiplier.toFixed(2)}x` : 
                `Краш! ${currentMultiplier.toFixed(2)}x`;
        }

        // Инициализация при загрузке
        window.onload = function() {
            initUser();
            // Инициализация графика
            chartCtx.fillStyle = '#58ff58';
            // Здесь должна быть логика отрисовки графика
        };
    </script>
</body>
</html>
