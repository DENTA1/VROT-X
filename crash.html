<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>UP-X Crash</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Обновленные стили */
        body {
            background: #0d1117;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .crash-chart {
            background: #161b22;
            height: 300px;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .multiplier {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #58ff58;
            text-shadow: 0 0 10px rgba(88, 255, 88, 0.5);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #fff;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bet-button {
            background: #238636;
            color: #fff;
        }

        .cashout-button {
            background: #da3633;
            color: #fff;
        }

        .balance {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .timer {
            text-align: center;
            font-size: 24px;
            margin: 10px 0;
        }

        .history {
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
        }

        .history-item {
            padding: 5px 0;
            border-bottom: 1px solid #30363d;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="balance">Balance: $<span id="balance">0</span></div>
        <div class="timer" id="timer">До начала игры: 10s</div>
        <div class="crash-chart">
            <canvas id="chart"></canvas>
        </div>
        <div class="multiplier" id="multiplier">1.00x</div>
        <div class="controls">
            <input type="number" id="betAmount" placeholder="Сумма ставки" min="1">
            <button class="bet-button" id="betBtn" onclick="placeBet()">Ставка</button>
            <button class="cashout-button" id="cashoutBtn" onclick="cashOut()" disabled>Забрать</button>
        </div>
        <div class="history">
            <h3>История игр:</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.firebasestorage.app",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let userRef;
        let currentGameRef;
        let isPlaying = false;
        let isBettingPhase = true;
        let currentMultiplier = 1.0;
        let betAmount = 0;
        let crashPoint = 1.0;
        let chartCtx;
        let animationFrame;
        let startTime;

        // Инициализация пользователя
        function getUserId() {
            const cookies = document.cookie.split(';');
            for(let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if(name === 'tg_user_id') return value;
            }
            const newId = 'user_' + Math.random().toString(36).substr(2, 9);
            document.cookie = `tg_user_id=${newId}; path=/; max-age=31536000`;
            return newId;
        }

        function initUser() {
            const userId = getUserId();
            userRef = database.ref('users/' + userId);
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val() || { balance: 1000, bets: [] };
                if(!snapshot.exists()) userRef.set(data);
                document.getElementById('balance').textContent = data.balance.toFixed(2);
            });
        }

        // Игровая логика
        function startNewGame() {
            isBettingPhase = true;
            crashPoint = calculateCrashPoint();
            currentGameRef = database.ref('games/' + Date.now());
            currentGameRef.set({
                status: 'betting',
                crashPoint: crashPoint,
                players: {}
            });

            let countdown = 10;
            const timerInterval = setInterval(() => {
                document.getElementById('timer').textContent = 
                    `До начала игры: ${countdown}s`;
                if(countdown <= 0) {
                    clearInterval(timerInterval);
                    startGameAnimation();
                    isBettingPhase = false;
                }
                countdown--;
            }, 1000);
        }

        function placeBet() {
            if(!isBettingPhase) return alert('Ставки закрыты!');
            
            const betInput = parseFloat(document.getElementById('betAmount').value);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                
                if(betInput < 1 || isNaN(betInput)) return alert('Некорректная сумма!');
                if(betInput > user.balance) return alert('Недостаточно средств!');

                betAmount = betInput;
                userRef.update({ balance: user.balance - betAmount });
                currentGameRef.child('players/' + getUserId()).set(betAmount);
                
                document.getElementById('betBtn').disabled = true;
                document.getElementById('cashoutBtn').disabled = false;
            });
        }

        function startGameAnimation() {
            isPlaying = true;
            startTime = Date.now();
            document.getElementById('timer').style.display = 'none';
            
            function updateChart() {
                if(!isPlaying) return;
                
                const elapsed = (Date.now() - startTime) / 1000;
                currentMultiplier = Math.exp(elapsed * 0.1) * 1.0;
                
                if(currentMultiplier >= crashPoint) {
                    endGame(false);
                    return;
                }

                document.getElementById('multiplier').textContent = 
                    currentMultiplier.toFixed(2) + 'x';
                
                drawChart(elapsed);
                animationFrame = requestAnimationFrame(updateChart);
            }
            
            updateChart();
        }

        function drawChart(time) {
            if(!chartCtx) {
                chartCtx = document.getElementById('chart').getContext('2d');
                chartCtx.fillStyle = '#161b22';
                chartCtx.fillRect(0, 0, 600, 300);
            }
            
            // Отрисовка графика
            const x = (time * 60) % 600;
            chartCtx.fillStyle = '#58ff58';
            chartCtx.fillRect(x, 300 - (currentMultiplier * 30), 2, 2);
        }

        function calculateCrashPoint() {
            const rand = Math.random();
            return Math.max(1.1, Math.floor(100 * (1 / (1 - rand))) / 100);
        }

        function cashOut() {
            if(!isPlaying) return;
            endGame(true);
        }

        function endGame(manualCashout) {
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            
            const winAmount = manualCashout ? betAmount * currentMultiplier : 0;
            const result = {
                amount: betAmount,
                multiplier: manualCashout ? currentMultiplier.toFixed(2) : 0,
                date: new Date().toISOString(),
                result: manualCashout ? 'win' : 'lose'
            };

            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                userRef.update({
                    balance: user.balance + winAmount,
                    bets: [...user.bets, result]
                });
            });

            updateHistory(result);
            resetUI();
            setTimeout(startNewGame, 5000);
        }

        function updateHistory(result) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.textContent = `${result.date} - ${result.amount}$ @ ${result.multiplier}x - ${result.result}`;
            document.getElementById('historyList').prepend(historyItem);
        }

        function resetUI() {
            document.getElementById('multiplier').textContent = '1.00x';
            document.getElementById('betBtn').disabled = false;
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('betAmount').value = '';
            document.getElementById('timer').style.display = 'block';
        }

        // Инициализация
        window.onload = function() {
            initUser();
            startNewGame();
            chartCtx = document.getElementById('chart').getContext('2d');
            chartCtx.fillStyle = '#161b22';
            chartCtx.fillRect(0, 0, 600, 300);
        };
    </script>
</body>
</html>
